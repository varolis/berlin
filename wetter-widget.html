<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Hava Durumu Widget</title>
  <style>
    :root {
      --gap: 10px;
    }

    /* ===== Grundlayout ===== */
    body {
      font-family: Arial, sans-serif;
      background: #1e1e1e;
      color: #fff;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100dvh;
      box-sizing: border-box;
      font-size: 200%; /* global Verdopplung */
    }

    #currentWeather {
      margin-bottom: 1rem;
      font-size: 1.5em;
      text-align: center;
      width: 100%;
    }

    /* ===== Forecast‚ÄëGrid ===== */
    #forecast {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: var(--gap);
      width: 100%;
      box-sizing: border-box;
    }

    .day {
      background: #2c2c2c;
      padding: 6px;
      border-radius: 8px;
      text-align: center;
      box-sizing: border-box;
      font-size: 1em; /* Basis, wird per JS skaliert */
    }

    .day div:last-child { white-space: nowrap; }

    /* ===== Kleinere Ger√§te: nur Heading‚ÄëGr√∂√üe anpassen ===== */
    @media (max-width: 500px) {
      body { font-size: 160%; }
      #currentWeather { font-size: 1.3em; }
    }
  </style>
</head>
<body>
  <div id="currentWeather">Y√ºkleniyor...</div>
  <div id="forecast"></div>

  <script>
    /* ---------------- Konfiguration ---------------- */
    let selectedCity = "Berlin,DE";

    /* ---------------- Dynamische Schrift-Anpassung ---------------- */
    function fitText() {
      const forecast = document.getElementById("forecast");
      const days     = forecast.querySelectorAll(".day");
      if (!days.length) return;

      // Schritt 1: Reset auf Ausgangsgr√∂√üe
      days.forEach(d => d.style.fontSize = "1em");

      // Schritt 2: So lange verkleinern, bis alles in einer Zeile ohne Scrollen passt
      let scale = 1.0;
      while (forecast.scrollWidth > forecast.clientWidth && scale > 0.4) {
        scale -= 0.05;
        days.forEach(d => d.style.fontSize = scale + "em");
      }
    }

    window.addEventListener("resize", () => {
      // Bei Gr√∂√üen√§nderung neu anpassen
      fitText();
    });

    /* ---------------- Wetter laden ---------------- */
    async function getWeather() {
      const currentEl  = document.getElementById("currentWeather");
      const forecastEl = document.getElementById("forecast");

      forecastEl.innerHTML = "";
      currentEl.innerText  = "Y√ºkleniyor...";

      const [cityName] = selectedCity.split(',').map(s => s.trim());

      try {
        /* Geo-Koordinaten */
        const geoRes  = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityName)}&count=1&language=en&format=json`);
        const geoData = await geoRes.json();
        if (!geoData.results?.length) {
          currentEl.innerText = `≈ûehir bulunamadƒ±: ${cityName}`;
          return;
        }
        const { latitude: lat, longitude: lon } = geoData.results[0];

        /* Aktuelles Wetter */
        const currentRes  = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`);
        const currentData = await currentRes.json();
        currentEl.innerText = `${cityName}: ${Math.round(currentData.current_weather.temperature)}¬∞C`;

        /* 7‚ÄëTage‚ÄëVorhersage */
        const forecastRes  = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_min,temperature_2m_max,weathercode&timezone=auto`);
        const forecastData = await forecastRes.json();

        const daysTr = ["Paz", "Pzt", "Salƒ±", "√áar", "Per", "Cum", "Cmt"];
        const icons  = {0:"‚òÄÔ∏è",1:"üå§Ô∏è",2:"‚õÖ",3:"‚òÅÔ∏è",45:"üå´Ô∏è",48:"üå´Ô∏è",51:"üåßÔ∏è",53:"üåßÔ∏è",55:"üåßÔ∏è",56:"üåßÔ∏è",57:"üåßÔøΩÔøΩ",61:"üåßÔ∏è",63:"üåßÔ∏è",65:"üåßÔ∏è",66:"üåßÔ∏è",67:"üåßÔ∏è",71:"üå®Ô∏è",73:"üå®Ô∏è",75:"üå®Ô∏è",77:"üå®Ô∏è",80:"üåßÔ∏è",81:"üåßÔ∏è",82:"üåßÔ∏è",85:"üå®Ô∏è",86:"üå®Ô∏è",95:"‚õàÔ∏è",96:"‚õàÔ∏è",99:"‚õàÔ∏è"};

        forecastData.daily.time.forEach((dateStr, i) => {
          const date = new Date(dateStr);
          const min  = Math.round(forecastData.daily.temperature_2m_min[i]);
          const max  = Math.round(forecastData.daily.temperature_2m_max[i]);
          const dayEl = document.createElement("div");
          dayEl.className = "day";
          dayEl.innerHTML = `<div>${daysTr[date.getDay()]}</div><div>${icons[forecastData.daily.weathercode[i]] ?? "‚ùì"}</div><div>${min}¬∞C / ${max}¬∞C</div>`;
          forecastEl.appendChild(dayEl);
        });

        // Nach dem Rendern Schriftgr√∂√üe anpassen
        requestAnimationFrame(fitText);
      } catch (err) {
        console.error("Hava durumu verisi y√ºklenirken hata olu≈ütu:", err);
        currentEl.innerText = "Hava durumu bilgisi alƒ±namadƒ±.";
      }
    }

    /* Nachrichten aus Parent‚ÄëSeite */
    window.addEventListener("message", (e) => {
      if (e.data?.type === "setCity") {
        selectedCity = e.data.city;
        getWeather();
      }
    });

    /* Initialer Aufruf */
    getWeather();
  </script>
</body>
</html>
