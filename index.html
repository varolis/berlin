<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Gebetszeiten heute</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="time" id="clock"></div>
  <div class="prayer-times" id="prayerTimes"></div>
  <div class="remain" id="remaining"></div>
  <div class="date" id="date"></div>

  <script src="gebetszeiten.js"></script>
  <script>
    async function fetchTemperature() {
      try {
        const res = await fetch("https://wttr.in/Berlin?format=%t");
        const temp = await res.text();
        return temp.trim();
      } catch {
        return "--Â°C";
      }
    }

    async function updateTemperatureOnly() {
      document.getElementById("date").textContent = getDateStr() +
        " - Temperatur: " + await fetchTemperature();
    }

    function updateClock(now) {
      document.getElementById("clock").textContent = now.toLocaleTimeString();

      if (prayerTimes.length === 0) return;

      let nextIdx = prayerTimes.findIndex(pt => now < pt.time);
      let next = prayerTimes[nextIdx];
      if (!next) {
        nextIdx = 0;
        next = prayerTimes[0];
      }

      let diff = (next.time - now) / 1000;
      if (diff < 0) diff += 86400;

      const h = String(Math.floor(diff / 3600)).padStart(2, '0');
      const m = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
      const s = String(Math.floor(diff % 60)).padStart(2, '0');
      document.getElementById("remaining").textContent = `Kalan zaman: ${h}:${m}:${s}`;

      const blocks = document.querySelectorAll(".prayer");
      blocks.forEach(b => b.classList.remove("active"));

      let currentIdx = -1;
      for (let i = 0; i < prayerTimes.length; i++) {
        if (now >= prayerTimes[i].time) {
          currentIdx = i;
        } else {
          break;
        }
      }
      if (currentIdx === -1) currentIdx = prayerTimes.length - 1;
      blocks[currentIdx]?.classList.add("active");
    }

    function startClockSync() {
      function tick() {
        const now = new Date();
        updateClock(now);
        const delay = 1000 - now.getMilliseconds();
        setTimeout(tick, delay);
      }
      tick();
    }

    async function updateAll() {
      await fetchPrayerTimes();
      await updateTemperatureOnly();
    }

    async function init() {
      await updateAll();
      startClockSync();
      setInterval(updateTemperatureOnly, 10 * 60 * 1000);

      const now = new Date();
      const nextReload = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 1, 0, 0);
      const timeout = nextReload - now;
      setTimeout(function reloadAtMidnight() {
        updateAll();
        setInterval(updateAll, 86400000);
      }, timeout);
    }

    init();
  </script>
</body>
</html>
