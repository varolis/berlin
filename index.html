<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Gebetszeiten heute</title>
  <link rel="stylesheet" href="style.css">
  <style>
    #settingsPanel {
      position: fixed;
      bottom: 2vh;
      right: 2vw;
      background: rgba(0,0,0,0.9);
      border: 1px solid white;
      padding: 1vh 1vw;
      display: none;
      flex-direction: column;
      align-items: center;
      z-index: 100;
    }

    #gearButton {
      position: fixed;
      bottom: 2vh;
      right: 2vw;
      font-size: 3vw;
      cursor: pointer;
      z-index: 101;
    }

    #settingsPanel input {
      font-size: 1.5vw;
      width: 100px;
      margin-bottom: 1vh;
    }

    #settingsPanel button {
      font-size: 1.5vw;
    }
  </style>
</head>
<body>

  <div class="time" id="clock"></div>
  <div class="prayer-times" id="prayerTimes"></div>
  <div class="remain" id="remaining"></div>
  <div class="date" id="date"></div>

  <div id="gearButton" onclick="toggleSettings()">⚙️</div>

  
<div id="settingsPanel">
  <label for="countrySelect">Ülke:</label>
  <select id="countrySelect" onchange="populateStates()"></select>
  <label for="stateSelect">Eyalet:</label>
  <select id="stateSelect" onchange="populateCities()"></select>
  <label for="citySelect">Şehir:</label>
  <select id="citySelect"></select>
  <button onclick="saveSelectedCity()">Değiştir</button>
</div>
<div id="selectedCityName" style="position: fixed; bottom: 2vh; left: 2vw; font-size: 2vw;"></div>


  <script src="gebetszeiten.js"></script>
  <script>
    function toggleSettings() {
      const panel = document.getElementById("settingsPanel");
      const gear = document.getElementById("gearButton");
      if (panel.style.display === "none") {
        panel.style.display = "flex";
        gear.style.display = "none";
        document.getElementById("cityId").value = localStorage.getItem("cityId") || "11002";
      } else {
        panel.style.display = "none";
        gear.style.display = "block";
      }
    }

    function saveCityId() {
      const newId = document.getElementById("cityId").value;
      if (newId) {
        localStorage.setItem("cityId", newId);
        toggleSettings();
        updateAll();
      }
    }

    async function fetchTemperature() {
      try {
        const res = await fetch("https://wttr.in/Berlin?format=%t");
        const temp = await res.text();
        return temp.trim();
      } catch {
        return "--°C";
      }
    }

    async function updateTemperatureOnly() {
      document.getElementById("date").textContent = getDateStr() +
        " - Hava: " + await fetchTemperature();
    }

    function updateClock(now) {
      document.getElementById("clock").textContent = now.toLocaleTimeString();

      if (prayerTimes.length === 0) return;

      let nextIdx = prayerTimes.findIndex(pt => now < pt.time);
      let next = prayerTimes[nextIdx];
      if (!next) {
        nextIdx = 0;
        next = prayerTimes[0];
      }

      let diff = (next.time - now) / 1000;
      if (diff < 0) diff += 86400;

      const h = String(Math.floor(diff / 3600)).padStart(2, '0');
      const m = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
      const s = String(Math.floor(diff % 60)).padStart(2, '0');
      document.getElementById("remaining").textContent = `Kalan zaman: ${h}:${m}:${s}`;

      const blocks = document.querySelectorAll(".prayer");
      blocks.forEach(b => b.classList.remove("active"));

      let currentIdx = -1;
      for (let i = 0; i < prayerTimes.length; i++) {
        if (now >= prayerTimes[i].time) {
          currentIdx = i;
        } else {
          break;
        }
      }
      if (currentIdx === -1) currentIdx = prayerTimes.length - 1;
      blocks[currentIdx]?.classList.add("active");
    }

    function startClockSync() {
      function tick() {
        const now = new Date();
        updateClock(now);
        const delay = 1000 - now.getMilliseconds();
        setTimeout(tick, delay);
      }
      tick();
    }

    async function updateAll() {
      await fetchPrayerTimes();
      await updateTemperatureOnly();
    }

    async function init() {
      await updateAll();
      startClockSync();
      setInterval(updateTemperatureOnly, 10 * 60 * 1000);

      const now = new Date();
      const nextReload = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 1, 0, 0);
      const timeout = nextReload - now;
      setTimeout(function reloadAtMidnight() {
        updateAll();
        setInterval(updateAll, 86400000);
      }, timeout);
    }

    init();
  </script>
<script>
function populateStates() {
  const country = document.getElementById("countrySelect").value;
  const stateSelect = document.getElementById("stateSelect");
  const citySelect = document.getElementById("citySelect");
  stateSelect.innerHTML = "";
  citySelect.innerHTML = "";
  const states = [...new Set(stadtliste.filter(e => e.country === country).map(e => e.state))].sort();
  states.forEach(state => {
    const opt = document.createElement("option");
    opt.value = state;
    opt.textContent = state;
    stateSelect.appendChild(opt);
  });
  populateCities();
}

function populateCities() {
  const country = document.getElementById("countrySelect").value;
  const state = document.getElementById("stateSelect").value;
  const citySelect = document.getElementById("citySelect");
  citySelect.innerHTML = "";
  stadtliste.filter(e => e.country === country && e.state === state).forEach(city => {
    const opt = document.createElement("option");
    opt.value = city.id;
    opt.textContent = city.city;
    citySelect.appendChild(opt);
  });
}

function saveSelectedCity() {
  const select = document.getElementById("citySelect");
  const name = select.options[select.selectedIndex].text;
  const id = select.value;
  document.getElementById("selectedCityName").textContent = name;
  localStorage.setItem("cityId", id);
  toggleSettings();
  updateAll();
}

window.addEventListener("load", () => {
  const countrySelect = document.getElementById("countrySelect");
  const countries = [...new Set(stadtliste.map(e => e.country))].sort();
  countries.forEach(country => {
    const opt = document.createElement("option");
    opt.value = country;
    opt.textContent = country;
    countrySelect.appendChild(opt);
  });
  populateStates();
});
</script>

<script>
let stadtliste = [];

fetch("diyanet_stadtliste.json")
  .then(res => res.json())
  .then(data => {
    stadtliste = data;
    const countrySelect = document.getElementById("countrySelect");
    const countries = [...new Set(stadtliste.map(e => e.country))].sort();
    countries.forEach(country => {
      const opt = document.createElement("option");
      opt.value = country;
      opt.textContent = country;
      countrySelect.appendChild(opt);
    });
    populateStates();
  });

function populateStates() {
  const country = document.getElementById("countrySelect").value;
  const stateSelect = document.getElementById("stateSelect");
  const citySelect = document.getElementById("citySelect");
  stateSelect.innerHTML = "";
  citySelect.innerHTML = "";
  const states = [...new Set(stadtliste.filter(e => e.country === country).map(e => e.state))].sort();
  states.forEach(state => {
    const opt = document.createElement("option");
    opt.value = state;
    opt.textContent = state;
    stateSelect.appendChild(opt);
  });
  populateCities();
}

function populateCities() {
  const country = document.getElementById("countrySelect").value;
  const state = document.getElementById("stateSelect").value;
  const citySelect = document.getElementById("citySelect");
  citySelect.innerHTML = "";
  stadtliste.filter(e => e.country === country && e.state === state).forEach(city => {
    const opt = document.createElement("option");
    opt.value = city.id;
    opt.textContent = city.city;
    citySelect.appendChild(opt);
  });
}

function saveSelectedCity() {
  const select = document.getElementById("citySelect");
  const name = select.options[select.selectedIndex].text;
  const id = select.value;
  document.getElementById("selectedCityName").textContent = name;
  localStorage.setItem("cityId", id);
  toggleSettings();
  updateAll();
}
</script>
</body>
</html>
